<div class="@Class @(string.IsNullOrWhiteSpace(Src) ? "d-none" : null) video-player-container"
	 style="@(Clickable ? "cursor: pointer" : null)"
	 @onclick="@OnClickHandler">
	<video
		@key="@Src"
		@ref="_player"
		src="@Src"
		style="width: 100%; height: 100%; display: block;"
		@onended="@VideoEndedHandler"
		@ontimeupdate="@TimeUpdateHandler"
		@oncanplaythrough="@OnLoadedData"
		preload="metadata"
		muted
		disableremoteplayback
		playsinline
        crossorigin="anonymous"></video>
	@if (!string.IsNullOrEmpty(Label))
	{
		<div class="video-label">@Label</div>
	}
	@if (Selectable)
	{
		<div class="video-overlay-checkbox" @onclick:stopPropagation="true">
			<MudCheckBox T="bool" Value="@IsSelected" ValueChanged="@IsSelectedChanged" Color="Color.Primary" />
		</div>
	}
</div>

@code {
	[Inject]
	public IJSRuntime JsRuntime { get; set; }
	
	[Parameter]
	public string Src { get; set; }
	
	[Parameter]
	public string Class { get; set; }

	[Parameter]
	public string Label { get; set; }

	[Parameter]
	public bool Clickable { get; set; }

	[Parameter]
	public EventCallback OnClick { get; set; }
	
	[Parameter]
	public EventCallback VideoEnded { get; set; }
	
	[Parameter]
	public EventCallback TimeUpdate { get; set; }

	[Parameter]
	public bool Selectable { get; set; }

	[Parameter]
	public bool IsSelected { get; set; }

	[Parameter]
	public EventCallback<bool> IsSelectedChanged { get; set; }

	public delegate void LoadedHandler();

	public event LoadedHandler Loaded;

	private ElementReference _player;
    public ElementReference VideoElement => _player;
	
	public ValueTask PlayAsync()
		=> JsRuntime.InvokeVoidAsync("HTMLVideoElement.prototype.play.call", _player);

	public ValueTask PauseAsync()
		=> JsRuntime.InvokeVoidAsync("HTMLVideoElement.prototype.pause.call", _player);

	public ValueTask<double> GetTimeAsync()
		=> JsRuntime.InvokeAsync<double>("getProperty", _player, "currentTime");

	public ValueTask SetTimeAsync(double time)
		=> JsRuntime.InvokeVoidAsync("setProperty", _player, "currentTime", time);

	public ValueTask SetPlaybackRateAsync(double rate)
		=> JsRuntime.InvokeVoidAsync("setProperty", _player, "playbackRate", rate);

	private Task VideoEndedHandler()
		=> VideoEnded.InvokeAsync();

	private Task TimeUpdateHandler()
		=> TimeUpdate.InvokeAsync();

	private Task OnClickHandler()
		=> Clickable ? OnClick.InvokeAsync() : Task.CompletedTask;

	private void OnLoadedData()
		=> Loaded?.Invoke();

}
