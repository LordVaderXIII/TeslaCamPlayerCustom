@implements IAsyncDisposable
<div class="@Class @(string.IsNullOrWhiteSpace(Src) ? "d-none" : null) video-player-container"
	 style="@(Clickable ? "cursor: pointer" : null)"
	 @onclick="@OnClickHandler">
	<video
		@key="@Src"
		@ref="_player"
		src="@Src"
		style="width: 100%; height: 100%; display: block;"
		@onended="@VideoEndedHandler"
		@oncanplaythrough="@OnLoadedData"
		preload="metadata"
		muted
		disableremoteplayback
		playsinline
        crossorigin="anonymous"
		aria-label="@Label"></video>
	@if (!string.IsNullOrEmpty(Label))
	{
		<div class="video-label">@Label</div>
	}
	@if (Selectable)
	{
		<div class="video-overlay-checkbox" @onclick:stopPropagation="true">
			<MudCheckBox T="bool" Value="@IsSelected" ValueChanged="@IsSelectedChanged" Color="Color.Primary" />
		</div>
	}
</div>

@code {
	[Inject]
	public IJSRuntime JsRuntime { get; set; }
	
	[Parameter]
	public string Src { get; set; }
	
	[Parameter]
	public string Class { get; set; }

	[Parameter]
	public string Label { get; set; }

	[Parameter]
	public bool Clickable { get; set; }

	[Parameter]
	public EventCallback OnClick { get; set; }
	
	[Parameter]
	public EventCallback VideoEnded { get; set; }
	
	[Parameter]
	public EventCallback<double> TimeUpdate { get; set; }

	[Parameter]
	public bool Selectable { get; set; }

	[Parameter]
	public bool IsSelected { get; set; }

	[Parameter]
	public EventCallback<bool> IsSelectedChanged { get; set; }

	public delegate void LoadedHandler();

	public event LoadedHandler Loaded;

	private ElementReference _player;
    public ElementReference VideoElement => _player;
    private DotNetObjectReference<VideoPlayer> _objRef;
	
	public ValueTask PlayAsync()
		=> JsRuntime.InvokeVoidAsync("HTMLVideoElement.prototype.play.call", _player);

	public ValueTask PauseAsync()
		=> JsRuntime.InvokeVoidAsync("HTMLVideoElement.prototype.pause.call", _player);

	public ValueTask<double> GetTimeAsync()
		=> JsRuntime.InvokeAsync<double>("getProperty", _player, "currentTime");

	public ValueTask SetTimeAsync(double time)
		=> JsRuntime.InvokeVoidAsync("setProperty", _player, "currentTime", time);

	public ValueTask SetPlaybackRateAsync(double rate)
		=> JsRuntime.InvokeVoidAsync("setProperty", _player, "playbackRate", rate);

	private Task VideoEndedHandler()
		=> VideoEnded.InvokeAsync();

	private Task OnClickHandler()
		=> Clickable ? OnClick.InvokeAsync() : Task.CompletedTask;

	private void OnLoadedData()
		=> Loaded?.Invoke();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && TimeUpdate.HasDelegate)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JsRuntime.InvokeVoidAsync("registerTimeUpdateObserver", _player, _objRef, 200);
        }
    }

    [JSInvokable]
    public async Task HandleTimeUpdate(double time)
    {
        await TimeUpdate.InvokeAsync(time);
    }

    public async ValueTask DisposeAsync()
    {
        if (_objRef != null)
        {
            try
            {
                await JsRuntime.InvokeVoidAsync("unregisterTimeUpdateObserver", _player);
            }
            catch (Exception)
            {
                // Ignored - JS runtime might be gone
            }
            _objRef.Dispose();
        }
    }
}
