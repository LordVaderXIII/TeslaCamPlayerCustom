@page "/"
@using TeslaCamPlayer.BlazorHosted.Client.Components
@using TeslaCamPlayer.BlazorHosted.Client.Models
@using TeslaCamPlayer.BlazorHosted.Shared.Models

@if (_filteredclips == null)
{
	<div class="loading-screen">
		Loading...
	</div>
}
else
{
    <!-- Mobile Toggle Button -->
    <div class="mobile-browser-toggle d-md-none">
        <MudIconButton Icon="@(_isBrowserVisible ? Icons.Material.Filled.Close : Icons.Material.Filled.Menu)"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@ToggleBrowser" />
    </div>

	<!-- Version Display -->
	<div class="version-display" @onclick="ShowChangelog">
		<MudText Typo="Typo.caption">v@(VersionInfo.CurrentVersion)</MudText>
	</div>

    <div class="user-profile-icon" @onclick="ShowSettings">
        <MudAvatar Color="Color.Secondary" Size="Size.Medium" Style="cursor: pointer">
            @GetInitials()
        </MudAvatar>
    </div>

	<div class="main-content">
		<div class="viewer-container">
			<ClipViewer @ref="_clipViewer"
			            PreviousButtonClicked="PreviousButtonClicked"
			            NextButtonClicked="NextButtonClicked"
			            IsExportMode="_isExportMode"
			            OnExportRequested="OnExportRequested"
                        OnTelemetryUpdated="OnTelemetryUpdated"
                        OnPathAvailable="OnPathAvailable" />
		</div>
		<div class="browser @(_isBrowserVisible ? "visible" : "")">
            <div class="browser-mode-switch px-4 py-2 d-flex justify-center">
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                    <MudButton Variant="@(!_isMapVisible ? Variant.Filled : Variant.Outlined)" Color="Color.Primary" OnClick="@(() => _isMapVisible = false)">Events</MudButton>
                    <MudButton Variant="@(_isMapVisible ? Variant.Filled : Variant.Outlined)" Color="Color.Primary" OnClick="@(() => _isMapVisible = true)">Map</MudButton>
                </MudButtonGroup>
            </div>

            @if (_isMapVisible)
            {
                <div style="flex: 1; height: 100%; width: 100%; min-height: 400px;">
                    <MapViewer @ref="_mapViewer" CurrentData="_currentTelemetry" Path="_currentPath" />
                </div>
            }
            else
            {
			<MudDatePicker
				@ref="_datePicker"
				PickerVariant="PickerVariant.Static"
				IsDateDisabledFunc="IsDateDisabledFunc"
				FirstDayOfWeek="DayOfWeek.Monday"
				Class="browser-date-picker"
				DateChanged="DatePicked"
				@onmousewheel="@DatePickerOnMouseWheel"/>

			<MudToolBar Class="py-2">
				<MudTooltip Text="Scan for new files only">
					<MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="@(() => RefreshEventsAsync(SyncMode.Incremental))"/>
				</MudTooltip>
				<MudTooltip Text="Rescan all files and rebuild database">
					<MudIconButton Icon="@Icons.Material.Filled.Autorenew" Size="Size.Small" OnClick="@(() => RefreshEventsAsync(SyncMode.Full))"/>
				</MudTooltip>
				<MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
				<MudTooltip Text="@(_isExportMode ? "Cancel Export" : "Export Clip")">
					<MudIconButton Icon="@(_isExportMode ? Icons.Material.Filled.Close : Icons.Material.Filled.MovieCreation)"
					               Color="@(_isExportMode ? Color.Error : Color.Default)"
					               Size="Size.Small"
					               OnClick="@ToggleExportMode"/>
				</MudTooltip>
				@if (_isExportMode)
				{
					<MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="@(() => _clipViewer.TriggerExportAsync())" Class="ml-2">Export</MudButton>
				}
				<MudTooltip Text="Downloads">
					@if (_hasProcessingJobs)
					{
						<MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" Class="mx-2" @onclick="@ShowDownloads" Style="cursor: pointer"/>
					}
					else
					{
						<MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Small" OnClick="@ShowDownloads" />
					}
				</MudTooltip>
				<MudSpacer/>
				<div>
					<MudIconButton Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" OnClick="@ToggleFilter"/>

					<MudPopover @bind-Open="_showFilter" AnchorOrigin="Origin.CenterLeft" TransformOrigin="Origin.CenterRight" Class="pa-4">
						<EventFilter Values="_eventFilter" ValuesChanged="EventFilterValuesChanged" />
					</MudPopover>
					<MudOverlay @bind-Visible="_showFilter" OnClick="ToggleFilter" />
				</div>
			</MudToolBar>

			<div @ref="_eventsList" class="events-list" @onscroll="EventListScrolled">
				<Virtualize TItem="Clip" ItemSize="@EventItemHeight" Items="@_filteredclips" OverscanCount="10">
					<ItemContent>
						<div class="event @(_activeClip == context ? "event--active" : null)" @key="@context.EndDate" @onclick="@(() => SetActiveClipMobile(context))">
							@if (!string.IsNullOrWhiteSpace(context.ThumbnailUrl))
							{
								<img class="thumbnail" src="@context.ThumbnailUrl" loading="lazy"/>
							}
							<div class="details ml-2">
								<div class="icons">
									@foreach (var icon in GetClipIcons(context))
									{
										<MudIcon Icon="@icon" Size="Size.Small" Class="mr-1"/>
									}
								</div>
								<div class="date">
									@((context.Event?.Timestamp ?? context.StartDate).ToString("yyyy-MM-dd HH:mm:ss"))
								</div>
							</div>
						</div>
					</ItemContent>
					<Placeholder>
						<div class="event">
							<MudSkeleton Class="thumbnail" Width="66.66px" />
							<div class="details ml-2">
								<div class="icons">
									<MudSkeleton Width="20%" />
								</div>
								<div class="date">
									<MudSkeleton Width="80%" />
								</div>
							</div>
						</div>
					</Placeholder>
				</Virtualize>
			</div>
            }
		</div>
	</div>
}
